<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Smart Coin® — 3D Donor Dedication Map (One-Light Rule)</title>
<style>
  :root{ --bg:#000; --panel:#111826; --text:#eaf0ff; --muted:#9aa3c9; --border:#1f2a4d; --accent:#6ee7ff; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #app{position:relative;width:100%;height:100vh;min-height:560px;background:#000}

  .chip{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle;border:1px solid #2f3b66}
  #legend{position:fixed;left:10px;top:10px;z-index:8;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:12px;color:#cfe1ff;opacity:.9}
  #status{position:fixed;left:10px;bottom:10px;z-index:8;background:var(--panel);color:var(--muted);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:12px;max-width:78vw;white-space:pre-wrap}
  #buttons{position:fixed;right:10px;top:10px;z-index:9;display:flex;gap:8px}
  .btn{background:var(--panel);color:#eaf0ff;border:1px solid var(--border);border-radius:999px;padding:8px 10px;font-size:12px;cursor:pointer}
  #menu{position:fixed;right:10px;top:44px;z-index:10;background:var(--panel);border:1px solid var(--border);border-radius:10px;display:none;min-width:240px;overflow:hidden}
  #menu.open{display:block}
  #menu .item{padding:8px 10px;border-bottom:1px solid #16223d;cursor:pointer;font-size:12px}
  #menu .item:last-child{border-bottom:none}
  #menu .item:hover{background:#0d142b}
  #help{position:fixed;right:10px;top:44px;z-index:10;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:12px;display:none;max-width:340px}
  #help.open{display:block}
  #tip{position:fixed;pointer-events:none;z-index:11;background:#0b1020;border:1px solid #223054;border-radius:6px;padding:6px 8px;font-size:12px;display:none;color:#dce6ff}
  @media (max-width:768px){ #legend{font-size:11px} .btn{padding:8px} }
</style>

<script src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>
<body>
<div id="app"></div>

<div id="legend">
  <div><span class="chip" style="background:#1e3a8a"></span>Dark blue: roots</div>
  <div><span class="chip" style="background:#93c5fd"></span>Light blue: primary +1 (max 1 per parent)</div>
  <div><span class="chip" style="background:#22c55e"></span>Green: extra donations from same parent</div>
  <div><span class="chip" style="background:#ef4444"></span>Red: everything downstream of any green</div>
</div>

<div id="buttons">
  <button id="btnPresets" class="btn">Presets ▾</button>
  <button id="btnHelp" class="btn">?</button>
</div>
<div id="menu"></div>
<div id="help">
  <b>Shortcuts</b><br>
  H — help ・ P — presets ・ I — isolate subtree on click<br>
  A — toggle ancestor path ・ F — depth fade on/off<br>
  [ / ] — page visible roots ・ R — reset view<br>
  Click any node to highlight descendants (+ optional ancestor path).
</div>
<div id="tip"></div>
<div id="status">Status: loading…</div>

<script type="module">
/* ---------- boot THREE ---------- */
const statusEl=document.getElementById('status'); const setStatus=m=>statusEl.textContent='Status: '+m; const showError=e=>{setStatus('Error: '+(e?.message||e));console.error(e)}
const rootEl=document.getElementById('app'); const menuEl=document.getElementById('menu'); const helpEl=document.getElementById('help'); const tipEl=document.getElementById('tip');

const THREE=await import('three'); const {OrbitControls}=await import('three/addons/controls/OrbitControls.js');
const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1)); renderer.setClearColor(0x000000,1); renderer.domElement.style.touchAction='none'; rootEl.appendChild(renderer.domElement);
const scene=new THREE.Scene(); scene.background=new THREE.Color(0x000000);
const camera=new THREE.PerspectiveCamera(55,1,0.1,5000);
const controls=new OrbitControls(camera, renderer.domElement); controls.enableDamping=true; controls.dampingFactor=0.05;
scene.add(new THREE.AmbientLight(0xffffff,0.9)); const dir=new THREE.DirectionalLight(0xffffff,0.55); dir.position.set(300,500,400); scene.add(dir);
function size(){const w=rootEl.clientWidth||window.innerWidth; const h=rootEl.clientHeight||Math.round(window.innerHeight*0.7); return {w:Math.max(1,w),h:Math.max(1,h)}}
function resize(){const {w,h}=size(); camera.aspect=w/h; camera.updateProjectionMatrix(); renderer.setSize(w,h,false)} window.addEventListener('resize',resize);
function resetView(){camera.position.set(0,0,760); controls.target.set(0,0,0); controls.update()} resetView(); resize();

/* ---------- state + utils ---------- */
const state={group:null,nodes:[],links:[],spheres:[],edges:null,glowDesc:null,glowAnc:null,rootWire:null,roots:[],levels:[],capped:false};
function xmur3(str){for(var i=0,h=1779033703^str.length;i<str.length;i++) h=Math.imul(h^str.charCodeAt(i),3432918353),h=h<<13|h>>>19; return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return(h^(h>>>16))>>>0}}
function mulberry32(a){return function(){var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return((t^t>>>14)>>>0)/4294967296 }}
function makeRNG(seedStr){if(!seedStr) return Math.random; const seed=xmur3(String(seedStr))(); return mulberry32(seed)}
function poisson(lambda,rand){if(lambda<=0) return 0; const L=Math.exp(-lambda); let k=0,p=1; do{k++;p*=rand()}while(p>L); return k-1}
function dispose(obj){obj.traverse(o=>{if(o.geometry)o.geometry.dispose(); if(o.material){Array.isArray(o.material)?o.material.forEach(m=>m.dispose()):o.material.dispose()}})}
function clearHi(){['glowDesc','glowAnc','rootWire'].forEach(k=>{const m=state[k]; if(m){state.group.remove(m); dispose(m); state[k]=null}}); state.spheres.forEach(m=>{m.material.transparent=false; m.material.opacity=1}); if(state.edges) state.edges.material.opacity=0.15}

/* ---------- presets & flags ---------- */
const PRESETS=[
  {name:'Sparse (demo)',   desc:'Few overlaps', p:{roots:40,  lightDepth:6,  lightProb:.8,  lightFan:1.2, lightDecay:.92, extraDepth:6, extraProb:.8, extraFan:1.4, extraDecay:.9,  radius:360, jitter:30, seed:'sparse', cap:5000}},
  {name:'Typical',         desc:'Balanced',     p:{roots:100, lightDepth:10, lightProb:.85, lightFan:1.6, lightDecay:.9,  extraDepth:10,extraProb:.85,extraFan:1.8, extraDecay:.88, radius:420, jitter:34, seed:'typical',cap:9000}},
  {name:'Aggressive',      desc:'Big trees',    p:{roots:160, lightDepth:14, lightProb:.88, lightFan:2.0, lightDecay:.9,  extraDepth:12,extraProb:.9, extraFan:2.2, extraDecay:.86, radius:520, jitter:38, seed:'agg',   cap:13000}},
  {name:'Showcase (wide)', desc:'Long cha
